version: '3.8'

services:
  # Apache + PHP 8.2
  apache:
    image: php:8.2-apache  # Или 8.1, 8.0
    ports:
      - "80:80"
    volumes:
      - ./www:/var/www/html  # Папка с сайтом
      - ./php.ini:/usr/local/etc/php/conf.d/custom.ini
      - ./apache2.conf:/etc/apache2/apache2.conf
    environment:
      PHP_MEMORY_LIMIT: "1024M"
      UPLOAD_MAX_FILESIZE: "128M"
      POST_MAX_SIZE: "128M"
      PHP_OPCACHE_ENABLE: "1"
      PHP_OPCACHE_MEMORY_CONSUMPTION: "256"
      PHP_OPCACHE_MAX_ACCELERATED_FILES: "20000"
      PHP_OPCACHE_REVALIDATE_FREQ: "0"
    command: >
      bash -c "apt-get update && apt-get install -y libzip-dev libpng-dev libjpeg-dev libfreetype6-dev
      && docker-php-ext-configure gd --with-freetype --with-jpeg
      && docker-php-ext-install pdo_mysql mysqli gd zip bcmath opcache
      && a2dismod php
      && a2dismod mpm_prefork
      && a2dismod mpm_worker
      && a2enmod mpm_event
      && a2enmod rewrite
      && a2enmod expires
      && a2enmod headers
      && a2enmod proxy
      && a2enmod proxy_fcgi
      && a2enmod setenvif
      && a2enmod alias
      && a2enmod dir
      && a2enmod mime
      && a2enmod env
      && a2enmod filter
      && a2enmod deflate
      && a2enmod status
      && a2enmod negotiation
      && a2enmod authz_core
      && a2enmod authz_host
      && a2enmod authn_core
      && a2enmod auth_basic
      && a2enmod access_compat
      && a2enmod socache_shmcb
      && a2enmod reqtimeout
      && a2enmod ssl
      && a2enmod headers
      && a2enmod unique_id
      && a2enmod vhost_alias
      && chmod 644 /etc/apache2/apache2.conf
      && chmod 644 /usr/local/etc/php/conf.d/custom.ini
      && apache2-foreground"

  # PHP-FPM
  php-fpm:
    image: php:8.2-fpm
    volumes:
      - ./www:/var/www/html
      - ./php.ini:/usr/local/etc/php/conf.d/custom.ini
    environment:
      PHP_MEMORY_LIMIT: "1024M"
      UPLOAD_MAX_FILESIZE: "128M"
      POST_MAX_SIZE: "128M"
      PHP_OPCACHE_ENABLE: "1"
      PHP_OPCACHE_MEMORY_CONSUMPTION: "256"
      PHP_OPCACHE_MAX_ACCELERATED_FILES: "20000"
      PHP_OPCACHE_REVALIDATE_FREQ: "0"
    command: >
      bash -c "apt-get update && apt-get install -y libzip-dev libpng-dev libjpeg-dev libfreetype6-dev
      && docker-php-ext-configure gd --with-freetype --with-jpeg
      && docker-php-ext-install pdo_mysql mysqli gd zip bcmath opcache
      && php-fpm"

  # MySQL 8
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: "root"  # Пароль рута
      MYSQL_DATABASE: "bitrix"     # Автосоздание БД
      MYSQL_USER: "bitrix"       # Юзер БД
      MYSQL_PASSWORD: "bitrix"   # Пароль юзера
      MYSQL_INNODB_BUFFER_POOL_SIZE: "1G"
      MYSQL_INNODB_LOG_FILE_SIZE: "256M"
      MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT: "2"
      MYSQL_INNODB_FLUSH_METHOD: "O_DIRECT"
    volumes:
      - mysql-data:/var/lib/mysql  # Сохранение данных БД
      - ./my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3306:3306"

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8080:80"
    environment:
      PMA_HOST: mysql
    depends_on:
      - mysql

volumes:
  mysql-data: